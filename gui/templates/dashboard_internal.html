<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="程序员数据看板--商家注册信息">
    <meta name="keywords" content="数据看板,商家注册"/>
    <title>程序员数据看板</title>

    <!-- CSS 文件 -->
    <link href="../static/css/root.css" rel="stylesheet">
    <link href="../static/css/index.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Montserrat&display=swap" rel="stylesheet">
    <!-- 引入Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- 引入ECharts图表库 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

    <style>

        /* 添加滚动功能 */
        .content-wrapper {
            position: fixed;
            top: 60px; /* 顶部导航高度 */
            left: 250px; /* 侧边栏宽度 */
            right: 0;
            bottom: 0;
            overflow-y: auto;
            background: #f5f7fa;
            /* 增加底部内边距 */
            padding: 20px 20px 80px;
        }

        /* 优化图表布局 */
        .chart-container {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #eaeaea;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .chart-update {
            font-size: 12px;
            color: #999;
        }

        .chart-content {
            height: 300px;
        }


        .stat-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #eaeaea;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            font-size: 22px;
        }


        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .data-table th {
            background-color: #f8f9fa;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
        }

        .data-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover td {
            background-color: #f8f9fa;
        }


        @media (max-width: 1200px) {
            .content-wrapper {
                left: 200px;
            }
        }

        @media (max-width: 992px) {
            .content-wrapper {
                left: 60px;
            }
        }


        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-item {
            flex: 1;
            min-width: 200px;
        }

        .filter-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .filter-item select {
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            background: #f9fbff;
            color: #333;
            font-size: 14px;
            line-height: 1.5;
            padding-top: 6px;
            padding-bottom: 8px;
            font-family: "Microsoft YaHei", sans-serif;
        }

        /* 新增：卡片布局优化 */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        @media (max-width: 1200px) {
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
        }


        .charts-row-1 {
            grid-template-columns: repeat(3, 1fr);
        }

        .charts-row-2 {
            grid-template-columns: 2fr 1fr;
        }


        @media (max-width: 768px) {
            /* 图表容器在小窗口时占满可用宽度，保持居中 */
            .chart-container {
                width: 100%;
                max-width: 500px; /* 限制最大宽度，避免拉伸变形 */
            }
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(47, 128, 237, 0.2);
            border-top: 4px solid #2f80ed;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* 状态消息样式 */
        .status-message i {
            font-size: 48px;
            color: #2f80ed;
            margin-bottom: 15px;
        }


        .stat-highlight {
            color: #3498db !important; /* 蓝色 */
            font-weight: 700;
            font-size: 2.2rem;
            text-shadow: 0 0 8px rgba(52, 152, 219, 0.3); /* 蓝色发光效果 */
        }

        /* 增长指示器样式 */
        @media (max-width: 992px) {
            .footer {
                left: 60px;
            }
        }

        /*活跃度表格搜索和分页样式 */

        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-right: none; /* 移除右侧边框 */
            border-radius: 4px 0 0 4px;
            font-size: 14px;
            box-sizing: border-box; /* 包含内边距和边框 */
        }

        .search-button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 0 4px 4px 0;
            background-color: #f0f0f0;
            cursor: pointer;
            box-sizing: border-box; /* 包含内边距和边框 */
        }

        .search-button:hover {
            background: #2980b9;
        }

        .activity-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
            padding: 10px 0;
        }

        .pagination-button {
            padding: 6px 12px;
            margin: 0 5px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .pagination-button:hover:not(:disabled) {
            background: #2980b9;
        }

        #page-info {
            margin: 0 15px;
            font-size: 14px;
            color: #555;
        }

        /* 确保表格不会溢出 */
        .chart-content table {
            width: 100%;
            table-layout: fixed;
        }

        .chart-content th,
        .chart-content td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 固定表格列宽 */
        .chart-content th:nth-child(1),
        .chart-content td:nth-child(1) {
            width: 10%;
        }

        .chart-content th:nth-child(2),
        .chart-content td:nth-child(2) {
            width: 25%;
        }

        .chart-content th:nth-child(3),
        .chart-content td:nth-child(3) {
            width: 15%;
        }

        .chart-content th:nth-child(4),
        .chart-content td:nth-child(4) {
            width: 15%;
        }

        .chart-content th:nth-child(5),
        .chart-content td:nth-child(5) {
            width: 35%;
        }

        .chart-container {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #eaeaea;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            width: 100%; /* 新增：占满父容器宽度 */
            box-sizing: border-box; /* 新增：确保padding不影响总宽度 */
        }

        .chart-content {
            height: 300px;
            width: 100%; /* 新增：图表内容占满容器宽度 */
        }

        /* 新增样式 - 确保统计卡片均匀分布 */
        .stats-container {
            grid-template-columns: repeat(2, 1fr) !important;
        }

        /* 时间趋势图占满整行 */
        .charts-row-2 {
            grid-template-columns: 1fr !important;
        }

        /* 新增注册提示样式 */
        .new-registration {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: fadeInOut 3s ease-in-out;
            display: none;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            20% {
                opacity: 1;
                transform: translateY(0);
            }
            80% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(20px);
            }
        }


    </style>
</head>
<body>
<div id="particles-js"></div>
<div class="loading"><img src="../static/images/loading.gif" alt="loading-img"></div>

<!-- START TOP -->
<div id="top" class="clearfix">
    <!-- Logo -->
    <div class="applogo">
        <a href="index_main.html" class="logo">
            <span class="logo-text">智创电商营销系统</span>
            <span class="logo-glow"></span>
        </a>
    </div>
    <!-- 菜单按钮  -->
    <a href="#" class="sidebar-open-button-mobile"><i class="fa fa-bars"></i></a>
    <a href="#" class="sidebar-open-button"><i class="fa fa-bars"></i></a>
    <!-- 搜索框 -->
    <form class="searchform">
        <label for="searchbox"></label><input type="text" class="searchbox" id="searchbox" placeholder="搜索">
        <span class="searchbutton"><i class="fa fa-search"></i></span>
    </form>

    <!-- 用户菜单 -->
    <ul class="top-right">
        <li class="dropdown link">
            <a href="#" data-toggle="dropdown" class="dropdown-toggle profilebox"><img
                    src="../static/images/用户头像.jpg" alt="img"><b>模拟用户</b><span
                    class="caret"></span></a>
            <ul class="dropdown-menu dropdown-menu-list dropdown-menu-right">
                <li role="presentation" class="dropdown-header">更多</li>
                <li><a href="#"><i class="fa falist fa-wrench"></i>设置</a></li>
                <li><a href="#"><i class="fa falist fa-lock"></i> 修改密码</a></li>
                <li><a href="#"><i class="fa falist fa-power-off"></i> 退出登录</a></li>
                <li class="divider"></li>
                <li><a href="#">更多功能更新中......</a></li>
            </ul>
        </li>
    </ul>
</div>
<!-- END TOP -->

<!-- START SIDEBAR -->
<div class="sidebar clearfix">
    <ul class="sidebar-panel nav">
        <li><a href="/home"><span class="icon color5"><i class="fa fa-home"></i></span>首页</a></li>
        <li><a href="#"><span class="icon color10"><i class="fa fa-th"></i></span>商品信息管理<span
                class="caret"></span></a>
            <ul>
                <li><a href="product_marketing.html">商品基础信息库</a></li>
                <li><a href="product_management.html">商品营销素材库</a></li>
            </ul>
        </li>
        <li><a href="test1.html"><span class="icon color5"><i class="fa fa-comment-o"></i></span>文案智造器</a></li>
        <li><a href="test2.html"><span class="icon color11"><i class="fa fa-photo"></i></span>营销图创作</a></li>
        <li><a href="test3.html"><span class="icon color8"><i class="fa fa-film"></i></span>短视频智造</a></li>
        <li><a href="http://127.0.0.1:5000/setting"><span class="icon color12"><i class="fa fa-smile-o"></i></span>数字直播大厅</a>
        </li>
        <li><a href="calendar.html"><span class="icon color8"><i class="fa fa-calendar-o"></i></span>营销日程规划<span
                class="label label-danger">NEW</span></a></li>
        <li><a href="note.html"><span class="icon color8"><i class="fa fa-bullhorn"></i></span>营销笔记发布</a></li>
        <li><a href="#" class="active"><span class="icon color8"><i class="fa fa-mortar-board"></i></span>数据统计<span
                class="caret"></span></a>
            <ul style="display: block;">
                <li><a href="sign_up.html">商家来源统计</a></li>
                <li><a href="dashboard_internal.html" class="active">程序员数据看板</a></li>
                <li><a href="dashboard.html">用户数据看板</a></li>
            </ul>
        </li>
        <li><a href="http://127.0.0.1:3000"><span class="icon color5"><i class="fa fa-desktop"></i></span>登录</a></li>
    </ul>
</div>
<!-- END SIDEBAR -->

<!-- START CONTENT -->
<div class="content-wrapper">
    <!-- Start Page Header -->
    <div class="page-header">
        <h1 class="title">程序员数据看板</h1>
        <ol class="breadcrumb">
            <li><a href="/">首页</a></li>
            <li class="active">程序员数据看板</li>
            <li><a href="#" onclick="fetchAndUpdateDashboardData()">刷新</a></li>
        </ol>
    </div>

    <!-- 1. 筛选控件区域 -->
    <div class="filter-container">
        <div class="filter-item">
            <label for="source-filter">来源渠道</label>
            <select id="source-filter">
                <option value="全部来源">全部来源</option>
                <option value="线上推广">线上推广</option>
                <option value="线下活动">线下活动</option>
                <option value="合作伙伴">合作伙伴</option>
                <option value="自然流量">自然流量</option>
                <option value="客户推荐">客户推荐</option>
                <option value="搜索引擎">搜索引擎</option>
                <option value="社交媒体">社交媒体</option>
            </select>
        </div>

        <div class="filter-item">
            <label for="category-filter">行业类别</label>
            <select id="category-filter">
                <option value="">全部行业</option>
                <option value="餐饮">餐饮</option>
                <option value="零售">零售</option>
                <option value="服务">服务</option>
                <option value="制造">制造</option>
                <option value="科技">科技</option>
                <option value="教育">教育</option>
                <option value="医疗">医疗</option>
                <option value="物流">物流</option>
            </select>
        </div>

        <div class="filter-item">
            <label for="region-filter">区域</label>
            <select id="region-filter">
                <option value="">全部区域</option>
                <option value="华东">华东</option>
                <option value="华北">华北</option>
                <option value="华南">华南</option>
                <option value="西南">西南</option>
                <option value="西北">西北</option>
                <option value="东北">东北</option>
            </select>
        </div>

        <div class="filter-item">
            <label for="active-filter">活跃状态</label>
            <select id="active-filter">
                <option value="">全部</option>
                <option value="active">活跃</option>
                <option value="inactive">不活跃</option>
            </select>
        </div>

        <div class="filter-item">
            <label for="global-time-range">时间范围</label>
            <select id="global-time-range" class="text-xs px-2 py-1 border border-gray-300 rounded">
                <option value="month">近30天</option>
                <option value="quarter">近90天</option>
                <option value="year">近1年</option>
            </select>
        </div>
    </div>

    <!-- 2. 统计卡片区 - 只保留程序员关注的指标 -->
    <div class="stats-container">
        <!-- 总商家数 -->
        <div class="stat-card">
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">总商家数</p>
                    <p class="stat-highlight" id="total-merchants">--</p>
                    <div class="mt-3 flex items-center">
                <span class="text-sm font-medium text-green-600">
                    <i class="fa fa-arrow-up mr-1"></i> <span id="totalMerchantsGrowth">--</span>
                </span>
                        <span class="text-xs text-gray-500 ml-2" id="merchantsComparisonText">较上月</span>
                    </div>
                </div>
                <div class="stat-icon bg-blue-100">
                    <i class="fa fa-users text-blue-500"></i>
                </div>
            </div>
        </div>

        <!-- 活跃商家占比 -->
        <div class="stat-card">
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">活跃商家占比</p>
                    <p class="stat-highlight" id="active-rate">--</p>
                    <div class="mt-3 flex items-center">
                <span class="text-sm font-medium text-green-600">
                    <i class="fa fa-arrow-up mr-1"></i> <span id="activeRateGrowth">--</span>
                </span>
                        <span class="text-xs text-gray-500 ml-2" id="activeRateComparisonText">较上月</span>
                    </div>
                </div>
                <div class="stat-icon bg-green-100">
                    <i class="fa fa-check-circle text-green-500"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. 核心图表区 - 第一行 -->
    <div class="charts-row-1" style="display: flex; flex-wrap: wrap; gap: 20px;">
        <!-- 来源分布饼图 -->
        <div class="chart-container" style="flex: 1; min-width: 300px;">
            <div class="chart-header">
                <h3 class="chart-title">商家来源分布</h3>
                <span class="chart-update" id="source-chart-update">更新于: --</span>
            </div>
            <div class="chart-content" id="source-chart">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- 行业类别柱状图 -->
        <div class="chart-container" style="flex: 1; min-width: 300px;">
            <div class="chart-header">
                <h3 class="chart-title">商家行业类别</h3>
                <span class="chart-update" id="category-chart-update">更新于: --</span>
            </div>
            <div class="chart-content" id="category-chart">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- 区域分布饼图 -->
        <div class="chart-container" style="flex: 1; min-width: 300px;">
            <div class="chart-header">
                <h3 class="chart-title">商家区域分布</h3>
                <span class="chart-update" id="region-chart-update">更新于: --</span>
            </div>
            <div class="chart-content" id="region-chart">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. 核心图表区 - 第二行 -->
    <div class="charts-row-2">
        <!-- 时间趋势图 -->
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">商家注册时间趋势</h3>
                <div class="flex items-center gap-2">
                    <span class="chart-update" id="time-chart-update">更新于: --</span>
                    <button id="simulate-registration" class="btn btn-sm btn-success">
                        <i class="fa fa-plus mr-1"></i>模拟新注册
                    </button>
                </div>
            </div>
            <div class="chart-content" id="time-chart">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. 明细数据区 - 只保留活跃度详情 -->
    <div class="grid grid-cols-1 gap-6 mb-6">
        <!-- 活跃度详情表格 -->
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">活跃度详情</h3>
                <label for="merchant-search"></label><input type="text" id="merchant-search"
                                                            placeholder="搜索商家名称..." class="search-input">
                <button id="search-button" class="search-button">
                    <i class="fa fa-search"></i>
                </button>
                <!-- 活跃度详情导出按钮 -->
                <button onclick="exportActivityData()" class="btn btn-primary">
                    <i class="fa fa-download mr-1"></i>导出数据
                </button>
            </div>

            <div class="chart-content">
                <table class="data-table">
                    <thead>
                    <tr>
                        <th>排名</th>
                        <th>商家名称</th>
                        <th>注册至今小时数</th>
                        <th>使用时长</th>
                        <th>活跃度</th>
                    </tr>
                    </thead>
                    <tbody id="activity-details-table">
                    </tbody>
                </table>


                <!-- 分页控件 -->
                <div class="activity-pagination">
                    <button id="prev-page" class="pagination-button">
                        <i class="fa fa-chevron-left"></i>
                    </button>
                    <span id="page-info">第 1 页</span>
                    <button id="next-page" class="pagination-button">
                        <i class="fa fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- 新增注册提示 -->
    <div id="new-registration" class="new-registration">
        <i class="fa fa-check-circle mr-2"></i>
        <span id="new-merchant-name">新商家</span> 已注册！总商家数：<span id="new-total-merchants">0</span>
    </div>

    <footer class="bg-white border-t border-gray-200 py-6 mt-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <p class="text-center text-sm text-gray-500">商家渠道分析系统 · 数据更新时间：<span id="update-time">-</span>
            </p>
        </div>
    </footer>
    <!-- Start Footer -->
    <div class="row footer">
        <div class="col-md-6 text-left">
            智行合一团队-智创电商营销系统
        </div>
    </div>
</div>
<!-- END CONTENT -->

<!-- JS 脚本 -->
<script src="../static/js/jquery.min.js"></script>
<script src="../static/js/bootstrap/bootstrap.min.js"></script>
<script type="text/javascript" src="../static/js/plugins.js"></script>
<!-- 粒子效果JS -->
<script src="../static/js/particles.min.js"></script>

<script>

    /* global echarts */
    function saveFilters() {
        const filters = {
            source: document.getElementById('source-filter').value,
            category: document.getElementById('category-filter').value,
            region: document.getElementById('region-filter').value,
            active: document.getElementById('active-filter').value,
            timeRange: document.getElementById('global-time-range').value
        };
        localStorage.setItem('dashboardInternalFilters', JSON.stringify(filters));
    }

    function loadFilters() {
        const savedFilters = localStorage.getItem('dashboardInternalFilters');
        if (savedFilters) {
            const filters = JSON.parse(savedFilters);
            document.getElementById('source-filter').value = filters.source;
            document.getElementById('category-filter').value = filters.category;
            document.getElementById('region-filter').value = filters.region;
            document.getElementById('active-filter').value = filters.active;
            document.getElementById('global-time-range').value = filters.timeRange;
        }
    }

    // 商家数据存储
    let allMerchants = [];
    let currentPage = 1;
    const pageSize = 5; // 每页显示5条数据

    // 初始化图表

    // 类型注释
    let sourceChart /** @type {echarts.any} */,
        categoryChart /** @type {echarts.any} */,
        regionChart /** @type {echarts.any} */,
        timeChart /** @type {echarts.any} */;


    function initCharts() {
        if (typeof echarts !== 'undefined') {
            try {
                sourceChart = echarts.init(document.getElementById('source-chart'));
                categoryChart = echarts.init(document.getElementById('category-chart'));
                regionChart = echarts.init(document.getElementById('region-chart'));
                timeChart = echarts.init(document.getElementById('time-chart'));
                return true;
            } catch (error) {
                console.error("图表初始化失败:", error);
                return false;
            }
        }
        return false;
    }

    // 尝试初始化图表
    if (!initCharts()) {
        // 图表初始化失败，显示错误信息
        displayChartError();
    }

    let autoRefreshEnabled = true;
    let refreshTimer = null;

    // 防抖函数
    function debounce(func, wait = 300) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    //导出数据
    function exportActivityData() {
        // 收集筛选条件
        const source = document.getElementById('source-filter').value;
        const category = document.getElementById('category-filter').value;
        const region = document.getElementById('region-filter').value;
        const active = document.getElementById('active-filter').value;
        const timeRange = document.getElementById('global-time-range').value;

        // 构建查询参数
        const params = new URLSearchParams({
            source: source,
            category: category,
            region: region,
            active: active,
            timeRange: timeRange
        });

        // 触发下载
        window.location.href = `/api/export_activity?${params.toString()}`;
    }

    // 图表错误显示
    function displayChartError() {
        const chartContainers = [
            'source-chart', 'category-chart', 'region-chart',
            'time-chart'
        ];

        chartContainers.forEach(id => {
            const container = document.getElementById(id);
            if (container) {
                container.innerHTML = `
                        <div class="status-message">
                            <i class="fa fa-exclamation-triangle"></i>
                            <p>图表加载失败，请检查网络连接</p>
                            <p class="text-sm">确保您有互联网访问权限</p>
                        </div>
                    `;
            }
        });
    }

    // 更新图表和数据
    const updateDashboardWithData = (data) => {
        /* 新增：类型注释，定义data的结构，解决属性未解析警告 */
        /** @type {
         {
         update_time: string;
         total_merchants: number;
         active_rate: number;
         total_merchants_growth: string | number;
         active_rate_growth: string | number;
         source_data: Array<{name: string; value: number}>;
         category_data: Array<{name: string; value: number}>;
         region_data: Array<{name: string; value: number}>;
         time_data: {months: string[]; counts: number[]};
         activity_details: {top_active: Array<{
         name: string;
         hours_since_registration: number;
         usage_hours: number;
         activity_ratio: number
         }>}
         }}
         */
        const dashboardData = data; // 重命名为dashboardData，让IDE关联类型注释
        // 更新最后更新时间
        document.getElementById('update-time').textContent = data.update_time;
        document.getElementById('source-chart-update').textContent = `更新于: ${dashboardData.update_time}`;
        document.getElementById('category-chart-update').textContent = `更新于: ${dashboardData.update_time}`;
        document.getElementById('region-chart-update').textContent = `更新于: ${dashboardData.update_time}`;
        document.getElementById('time-chart-update').textContent = `更新于: ${dashboardData.update_time}`;

        // 更新统计卡片
        document.getElementById('total-merchants').textContent = dashboardData.total_merchants.toLocaleString();
        document.getElementById('active-rate').textContent = `${dashboardData.active_rate}%`;


        // 根据时间范围更新比较文本
        function getComparisonText(timeRange) {
            const texts = {
                'month': '较上月',
                'quarter': '较上季度',
                'year': '较去年'
            };
            return texts[timeRange] || '较上期';
        }

        const timeRange = document.getElementById('global-time-range').value;
        const comparisonText = getComparisonText(timeRange);

        document.getElementById('merchantsComparisonText').textContent = comparisonText;
        document.getElementById('activeRateComparisonText').textContent = comparisonText;

// 处理无数据情况
        if (dashboardData.total_merchants_growth === "--") {
            document.getElementById('totalMerchantsGrowth').textContent = "--";
        } else {
            document.getElementById('totalMerchantsGrowth').textContent =
                dashboardData.total_merchants_growth + "%";
        }

        if (dashboardData.active_rate_growth === "--") {
            document.getElementById('activeRateGrowth').textContent = "--";
        } else {
            document.getElementById('activeRateGrowth').textContent =
                dashboardData.active_rate_growth + "%";
        }

        // 1. 来源分布饼图（删除 minAngle 等强制显示0值的配置）
        sourceChart.setOption({
            tooltip: {
                trigger: 'item',
                formatter: '{a} <br/>{b}: {c} ({d}%)'
            },
            legend: {
                orient: 'horizontal',
                bottom: 10
            },
            series: [{
                name: '来源分布',
                type: 'pie',
                radius: '50%',
                data: dashboardData.source_data.map(item => ({
                    name: item.name,
                    value: item.value
                })),
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
                // 移除 minAngle 等强制显示0值的配置
            }]
        });

// 2. 行业类别柱状图（无需特殊配置，ECharts自动忽略值为0的条目）
        categoryChart.setOption({
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                }
            },
            xAxis: {
                type: 'category',
                data: dashboardData.category_data.map(item => item.name),  // 仅包含非0类别的名称
                axisLabel: {
                    rotate: 45
                }
            },
            yAxis: {
                type: 'value',
                name: '商家数量'
            },
            series: [{
                name: '行业分布',
                type: 'bar',
                data: dashboardData.category_data.map(item => item.value),  // 仅包含非0类别的值
                itemStyle: {
                    color: function (params) {
                        const colorList = ['#5470C6', '#91CC75', '#FAC858', '#EE6666', '#73C0DE', '#3BA272', '#FC8452', '#9A60B4'];
                        return colorList[params.dataIndex % colorList.length];
                    }
                }
            }]
        });

// 3. 区域分布饼图（同来源分布，删除强制显示0值的配置）
        regionChart.setOption({
            tooltip: {
                trigger: 'item',
                formatter: '{a} <br/>{b}: {c} ({d}%)'
            },
            legend: {
                orient: 'horizontal',
                bottom: 10
            },
            series: [{
                name: '区域分布',
                type: 'pie',
                radius: '50%',
                data: dashboardData.region_data.map(item => ({
                    name: item.name,
                    value: item.value
                }))
                // 移除 minAngle 等强制显示0值的配置
            }]
        });


        // 更新时间趋势图
        timeChart.setOption({
            tooltip: {
                trigger: 'axis'
            },
            xAxis: {
                type: 'category',
                data: dashboardData.time_data.months
            },
            yAxis: {
                type: 'value'
            },
            series: [{
                name: '新增商家',
                type: 'line',
                data: dashboardData.time_data.counts,
                smooth: true,
                color: '#3b82f6',
                areaStyle: {
                    color: {
                        type: 'linear',
                        x: 0, y: 0, x2: 0, y2: 1,
                        colorStops: [
                            {offset: 0, color: 'rgba(59, 130, 246, 0.2)'},
                            {offset: 1, color: 'rgba(59, 130, 246, 0)'}
                        ]
                    }
                },
                lineStyle: {
                    width: 3
                }
            }]
        });

        // 保存商家数据用于分页和搜索
        allMerchants = [...dashboardData.activity_details.top_active];

        // 更新活跃度详情表格
        updateActivityTable();
    };

    // 搜索商家
    function searchMerchants() {
        const searchTerm = document.getElementById('merchant-search').value.toLowerCase();
        currentPage = 1; // 重置到第一页

        if (!searchTerm) {
            updateActivityTable(allMerchants);
            return;
        }

        const filtered = allMerchants.filter(merchant =>
            merchant.name.toLowerCase().includes(searchTerm)
        );
        updateActivityTable(filtered);
    }

    // 上一页
    function goToPrevPage() {
        if (currentPage > 1) {
            currentPage--;
            updateActivityTable();
        }
    }

    // 下一页
    function goToNextPage() {
        const totalPages = Math.ceil(allMerchants.length / pageSize);
        if (currentPage < totalPages) {
            currentPage++;
            updateActivityTable();
        }
    }


    function updateActivityTable(data = allMerchants) {
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const pageData = data.slice(startIndex, endIndex);

        // 更新表格
        const activityDetailsTable = document.getElementById('activity-details-table');
        activityDetailsTable.innerHTML = '';

        pageData.forEach((merchant, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${startIndex + index + 1}</td>
            <td>${merchant.name}</td>
            <td>${Math.round(merchant.hours_since_registration)}</td>
            <td>${Math.round(merchant.usage_hours)}</td>
            <td>
                <div class="progress-bar">
                    <div class="progress-value" style="width: ${merchant.activity_ratio * 100}%"></div>
                </div>
                <span>${(merchant.activity_ratio * 100).toFixed(1)}%</span>
            </td>
        `;
            activityDetailsTable.appendChild(row);
        });

        // 更新分页信息
        const totalPages = Math.ceil(data.length / pageSize);
        document.getElementById('page-info').textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;

        // 更新按钮状态
        document.getElementById('prev-page').disabled = currentPage <= 1;
        document.getElementById('next-page').disabled = currentPage >= totalPages || totalPages === 0;
    }


    // 绑定搜索和分页事件
    document.getElementById('search-button').addEventListener('click', searchMerchants);
    document.getElementById('merchant-search').addEventListener('keyup', function (e) {
        if (e.key === 'Enter') searchMerchants();
    });
    document.getElementById('prev-page').addEventListener('click', goToPrevPage);
    document.getElementById('next-page').addEventListener('click', goToNextPage);

    let lastUpdateTime = null;

    // 获取数据并更新图表
    async function fetchAndUpdateDashboardData() {
        loadFilters();
        // 显示加载状态
        document.querySelectorAll('.text-3xl, .text-2xl').forEach(el => el.textContent = '加载中...');

        // 确保图表已初始化
        if (!sourceChart) {
            if (!initCharts()) {
                displayChartError();
            }
        }

        // 构建请求参数
        const params = new URLSearchParams();
        params.append('timeRange', document.getElementById('global-time-range').value);
        params.append('type', 'external');

        // 添加最后更新时间（如果存在）
        if (lastUpdateTime) {
            params.append('last_update', lastUpdateTime);
        }

        // 添加平台参数
        const selectedPlatforms = [];
        document.querySelectorAll('input[name="platform"]:checked').forEach(checkbox => {
            selectedPlatforms.push(checkbox.value);
        });
        params.append('platforms', selectedPlatforms.join(','));

        try {

            const sourceFilter = document.getElementById('source-filter').value;
            const categoryFilter = document.getElementById('category-filter').value;
            const regionFilter = document.getElementById('region-filter').value;
            const activeFilter = document.getElementById('active-filter').value;
            const timeRange = document.getElementById('global-time-range').value;

// 构建查询参数
            let params = `timeRange=${timeRange}&type=internal`;

            if (sourceFilter && sourceFilter !== "全部来源") {
                params += `&source=${encodeURIComponent(sourceFilter)}`;
            }
            if (categoryFilter) {
                params += `&category=${encodeURIComponent(categoryFilter)}`;
            }
            if (regionFilter) {
                params += `&region=${encodeURIComponent(regionFilter)}`;
            }
            if (activeFilter) {
                params += `&active=${encodeURIComponent(activeFilter)}`;
            }

            const url = `/api/dashboard/data?${params}`;

            const response = await fetch(url);
            if (!response.ok)
                throw new Error('网络请求失败');

            const data = await response.json();

            if (data.last_update) {
                lastUpdateTime = data.last_update;
            }
            updateDashboardWithData(data);
        } catch (error) {
            console.error('获取数据失败,使用模拟数据', error);

            /*模拟数据（只包含程序员需要的数据，后期注释即可）
           const mockData = {
                source_data: [
                    { name: '线上推广', value: 120 },
                    { name: '线下活动', value: 85 },
                    { name: '合作伙伴', value: 65 },
                    { name: '自然流量', value: 45 },
                    { name: '客户推荐', value: 35 },
                    { name: '搜索引擎', value: 25 },
                    { name: '社交媒体', value: 15 }
                ],
                category_data: [
                    { name: '餐饮', value: 95 },
                    { name: '零售', value: 78 },
                    { name: '服务', value: 62 },
                    { name: '制造', value: 54 },
                    { name: '科技', value: 48 },
                    { name: '教育', value: 36 },
                    { name: '医疗', value: 28 },
                    { name: '物流', value: 22 }
                ],
                region_data: [
                    { name: '华东', value: 128 },
                    { name: '华北', value: 96 },
                    { name: '华南', value: 84 },
                    { name: '西南', value: 65 },
                    { name: '西北', value: 42 },
                    { name: '东北', value: 35 }
                ],
                time_data: {
                    months: ['2023-01', '2023-02', '2023-03', '2023-04', '2023-05', '2023-06', '2023-07', '2023-08', '2023-09', '2023-10', '2023-11', '2023-12'],
                    counts: [25, 32, 45, 38, 52, 48, 65, 72, 58, 62, 78, 85]
                },
                activity_details: {
                    top_active: [
                        { name: '商家A', hours_since_registration: 720, usage_hours: 480, activity_ratio: 0.67 },
                        { name: '商家B', hours_since_registration: 600, usage_hours: 420, activity_ratio: 0.70 },
                        { name: '商家C', hours_since_registration: 480, usage_hours: 360, activity_ratio: 0.75 },
                        { name: '商家D', hours_since_registration: 360, usage_hours: 300, activity_ratio: 0.83 },
                        { name: '商家E', hours_since_registration: 240, usage_hours: 200, activity_ratio: 0.83 }
                    ]
                },
                total_merchants: 385,
                active_rate: 65.2,
                update_time: new Date().toLocaleString()
            };

            updateDashboardWithData(mockData);*/
        } finally {
            // 递归调用实现连续刷新
            if (autoRefreshEnabled) {
                refreshTimer = setTimeout(fetchAndUpdateDashboardData, 30000); // 30秒刷新间隔
            }
        }
    }


    function startAutoRefresh() {
        autoRefreshEnabled = true;
        fetchAndUpdateDashboardData(); // 启动第一次更新
    }

    function stopAutoRefresh() {
        autoRefreshEnabled = false;
        if (refreshTimer) {
            clearTimeout(refreshTimer);
        }
    }

    // 页面可见性监听
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    });

    // 防抖后的刷新函数
    const debouncedFetch = debounce(fetchAndUpdateDashboardData, 300);

    // 绑定筛选器变化事件
    document.getElementById('source-filter').addEventListener('change', function () {
        saveFilters();
        debouncedFetch();
    });
    document.getElementById('category-filter').addEventListener('change', function () {
        saveFilters();
        debouncedFetch();
    });
    document.getElementById('region-filter').addEventListener('change', function () {
        saveFilters();
        debouncedFetch();
    });
    document.getElementById('active-filter').addEventListener('change', function () {
        saveFilters();
        debouncedFetch();
    });
    document.getElementById('global-time-range').addEventListener('change', function () {
        saveFilters();
        debouncedFetch();
    });
    // 启动自动刷新
    startAutoRefresh();

    // 窗口resize事件
    window.addEventListener('resize', function () {
        // 延迟重绘，避免频繁触发（防抖）
        clearTimeout(window.resizeTimer);
        window.resizeTimer = setTimeout(function () {
            // 确保所有图表实例都被重绘
            if (sourceChart) sourceChart.resize();
            if (categoryChart) categoryChart.resize();
            if (regionChart) regionChart.resize();
            if (timeChart) timeChart.resize();

            // 强制图表容器重新计算尺寸
            document.querySelectorAll('.chart-container').forEach((el) => {
                const container /** @type {HTMLElement} */ = el; // 加类型注释
                container.style.width = '100%';
                container.offsetHeight; // 触发重排
            });
        }, 100);
    });

    // 新增模拟注册功能（数据集，后期注释即可）
    document.getElementById('simulate-registration').addEventListener('click', function () {
        // 生成随机商家名称
        const prefixes = ['优品', '创新', '卓越', '精品', '时尚', '科技', '美味', '全球'];
        const suffixes = ['商贸', '科技', '食品', '服饰', '电子', '家居', '百货', '连锁'];
        const randomName = prefixes[Math.floor(Math.random() * prefixes.length)] +
            suffixes[Math.floor(Math.random() * suffixes.length)] +
            Math.floor(Math.random() * 1000);

        // 更新总商家数
        const totalMerchants = document.getElementById('total-merchants');
        const currentCount = parseInt(totalMerchants.textContent.replace(/,/g, '') || 0);
        const newCount = currentCount + 1;
        totalMerchants.textContent = newCount.toLocaleString();

        // 更新增长百分比
        document.getElementById('totalMerchantsGrowth').textContent =
            ((Math.random() * 5) + 1).toFixed(1) + '%';

        // 显示提示
        document.getElementById('new-merchant-name').textContent = randomName;
        document.getElementById('new-total-merchants').textContent = newCount;
        const notification = document.getElementById('new-registration');
        notification.style.display = 'block';

        // 3秒后隐藏提示
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);

        // 添加到活跃度表格顶部
        const newMerchant = {
            name: randomName,
            hours_since_registration: 0,
            usage_hours: 0,
            activity_ratio: 0.1
        };

        allMerchants.unshift(newMerchant);
        currentPage = 1;
        updateActivityTable();
    });


    // 在页面底部添加
    function initMerchantTracking() {
        // 定义需要跟踪的页面（与后端一致）
        const trackedPages = [
            '/dashboard',
            '/dashboard_internal',
            '/product_management',
            '/product_marketing',
            '/note',
            '/calendar',
            '/test1',
            '/test2',
            '/test3',
            '/setting'
        ];

        // 检查当前是否在跟踪页面
        let isTrackedPage = false;
        for (const page of trackedPages) {
            if (window.location.pathname.startsWith(page)) {
                isTrackedPage = true;
                break;
            }
        }

        if (!isTrackedPage) return;

        let merchantId = sessionStorage.getItem('merchant_id') ||
            localStorage.getItem('merchant_id');

        if (merchantId) {
            // 设置会话开始时间
            const sessionStartKey = 'tracked_page_session_start';
            if (!sessionStorage.getItem(sessionStartKey)) {
                sessionStorage.setItem(sessionStartKey, Date.now().toString());
            }

            // 页面离开时发送使用数据
            window.addEventListener('beforeunload', () => {
                const sessionStart = parseInt(
                    sessionStorage.getItem(sessionStartKey)
                );
                const duration = (Date.now() - sessionStart) / 1000; // 秒

                // 发送到后端更新
                navigator.sendBeacon('/api/track_usage', JSON.stringify({
                    merchant_id: merchantId,
                    session_seconds: duration,
                    page: window.location.pathname
                }));

                // 清除会话标记
                sessionStorage.removeItem(sessionStartKey);
            });
        }
    }


    // 页面加载时初始化跟踪
    document.addEventListener('DOMContentLoaded', initMerchantTracking);

</script>
</body>
</html>